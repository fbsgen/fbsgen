import "fbsgen/base"
import "fbsgen/dict"

proto_block(proto, module) ::= <<
«main_proto_block(proto, module, new_writable.(true))»
>>

main_proto_block(proto, module, writable) ::= <<
<!DOCTYPE html>
<html>
<head>
  <title>
    «if(module.o.("raw"))»raw«else»fbs«endif»: «proto.sourcePath»
  </title>
  <style>
    body {
      color: #555;
      background-color: #EEE;
      font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif;
      font-size: 1.1em;
    }
    a {
      text-decoration: none;
    }
    div.nested {
      margin-left: 1em;
    }
    div.nested h2 {
      margin-top: 0.5em;
    }
    div.message h2, div.enum h2 {
      margin-bottom: 0;
    }
    div.message h2 div, div.enum h2 div {
      font-weight: normal;
      font-size: 0.75em;
    }
    div.message h2 a {
      color: #CD5C5C;
    }
    div.enum h2 a {
      color: #FFA07A;
    }
    div.message h2 span, div.enum h2 span {
      font-size: 0.73em;
    }
    div.field {
      margin-left: 1em;
    }
    div.field > span {
      color: #4682B4;
    }
    div.field > b > a {
      color: #CD5C5C;
    }
    div.e.field > b > a {
      color: #FFA07A;
    }
    .comment {
      color: #999988;
    }
    .attr {
      font-weight: normal;
    }
    div.message > h2 > div.comment, div.enum > h2 > div.comment {
      font-size: 0.70em;
    }
  </style>
</head>
<body>
  <div class="comment">
    // source: «proto.sourcePath»
  </div>
  <div>
    <b>«if(module.o.("raw"))»package«else»namespace«endif»</b> «proto.declaredPackageName»;
  </div>
  «proto.messages:message_block(module, writable); separator="\n"»
  «proto.enumGroups:enum_block(module, writable); separator="\n"»
</body>
>>

enum_block(eg, module, writable, nested=false) ::= <<
<div class="enum«if(nested)» nested«endif»">
  <h2>
    «enum_top(eg, module, writable)»
    <span>enum</span>
    <a href="#«eg.relativeName; format="\.==-"»" id="«eg.relativeName; format="\.==-"»">
      «if(module.o.("raw"))»
      «eg.name»
      «else»
      «eg.cppRelativeName»
      «endif»
    </a>
    «if(!module.o.("raw"))»
    <span class="attr">: <b>«get_fbs_int_type.(eg.ta.name)»</b>«if(!eg.ta.emptyP)» («eg.ta.p:{k|«k»: «eg.ta.p.(k)»}; separator=", "»)«endif»</span>
    «endif»
    «eg.declaredValues:v_decl(module, writable); separator="\n"»
  </h2>
</div>
>>

enum_top(eg, module, writable) ::= <%
«if(module.o.("raw"))»
«eg.comments:{c|<div class="comment">/// «c»</div>}; separator="\n"»
«eg.a.values:{a|<div>@«a.name»«if(!a.emptyP)»(«a.p:{k|«k» = «a.p.(k)»}; separator=", "»)«endif»</div>}; separator="\n"»
«endif»
%>

v_decl(v, module, writable) ::= <<
<div class="field">
  <span>«v.name»</span> = «v.number»;
</div>
>>

message_block(message, module, writable, nested=false) ::= <<
<div class="message«if(nested)» nested«endif»">
  <h2>
    «message_top(message, module, writable)»
    <span>«message_kind(message, module, writable)»</span>
    <a href="#«message.relativeName; format="\.==-"»" id="«message.relativeName; format="\.==-"»">
      «if(module.o.("raw"))»
      «message.name»
      «else»
      «message.cppRelativeName»
      «endif»
    </a>
    «if(!module.o.("raw") && message.ta)»
    «if(!message.ta.emptyP)»
    <span class="attr">: («message.ta.p:{k|«k»: «message.ta.p.(k)»}; separator=", "»)</span>
    «endif»
    «endif»
  </h2>
  «if(module.o.("raw"))»
  «message.declaredFields:raw_field_decl(module, writable); separator="\n"»
  «message.nestedMessages:message_block(module, writable, true); separator="\n"»
  «message.nestedEnumGroups:enum_block(module, writable, true); separator="\n"»
  «else»
  «message.declaredFields:fbs_field_decl(module, writable); separator="\n"»
  «endif»
</div>
«if(!module.o.("raw"))»
«message.nestedMessages:message_block(module, writable); separator="\n"»
«message.nestedEnumGroups:enum_block(module, writable); separator="\n"»
«endif»
>>

message_top(message, module, writable) ::= <%
«if(module.o.("raw"))»
«message.comments:{c|<div class="comment">/// «c»</div>}; separator="\n"»
«message.a.values:{a|<div>@«a.name»«if(!a.emptyP)»(«a.p:{k|«k» = «a.p.(k)»}; separator=", "»)«endif»</div>}; separator="\n"»
«endif»
%>

message_kind(message, module, writable) ::= <%
«if(module.o.("raw"))»
message
«elseif(message.a.("struct"))»
struct
«else»
table
«endif»
%>

fbs_field_decl(field, module, writable) ::= <<
<div class="field«if(field.enumField)» e«endif»">
  <span>«field.name»</span>: «if(field.repeated)»[«endif»<b>«fbs_field_type(field, module, writable)»</b>«if(field.repeated)»]«endif»
  (id: «writable.n.(field.number).dec.num»«if(field.o.("deprecated"))», deprecated«endif»);
</div>
>>

fbs_field_type(field, module, writable) ::= <%
«if(field.userDefinedType)»
<a href="#«field.userDefinedType.relativeName; format="\.==-"»"><i>«field.fbsType»</i></a>
«else»
<span>«field.fbsType»</span>
«endif»
%>

raw_field_decl(field, module, writable) ::= <<
<div class="field«if(field.enumField)» e«endif»">
  «field.comments:{c|<div class="comment">/// «c»</div>}; separator="\n"»
  <i>«field.modifier; format="LOWER"»</i> <b>«raw_field_type(field, module, writable)»</b> <span>«field.name»</span> = «field.number»;
</div>
>>

raw_field_type(field, module, writable) ::= <%
«if(field.userDefinedType)»
<a href="#«field.userDefinedType.relativeName; format="\.==-"»"><i>«field.javaType»</i></a>
«else»
<span>«field.class.simpleName; format="LOWER"»</span>
«endif»
%>
